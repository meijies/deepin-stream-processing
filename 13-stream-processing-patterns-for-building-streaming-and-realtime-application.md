# 构建流和实时应用的十三种流处理模式

> 作者Srinath Perera [原文链接](https://iwringer.wordpress.com/2015/08/03/patterns-for-streaming-realtime-analytics/)。水平有限,不足之处，欢迎指正。

## 简介
越来越多的用例，我们想要更快的对数据做出响应，而不是将他们存储到磁盘，定期地处理并对数据做出响应。这可以通过实时分析来完成。

实时分析有两个方面:
+ 实时交互式/Ad-hoc分析(用户发出ad-hoc动态查询并且系统以交互方式响应)。这样的系统有Druid, SAP Hana, VoltDB, MemSQL和Apache Drill
+ 实时流分析/流处理(用户发出一次静态查询并且不再改变，系统在数据进入时并不存储而是直接处理)。这由流处理引擎来支持，这些工具的例子包括WSO2流处理引擎和Apache Flink。(更多细节见[什么是流处理](what-is-stream.md))

实时交互式分析允许用户使用ad-hoc查询探索数据。查询应该在10s以内响应，这被认为是人类可接受的交互等待上限。然而，本教程关注于流处理，它当数据进入系统时并不存储而是直接处理，快速响应，通常在几毫秒内。这些不是新技术。历史回到活动数据库(2000+)，流处理(例如，Aurora(2003), Borealis(2005+)和之后的Apache Storm)，分布式流操作(2005),复杂事件处理。在2015~2018年之间，大部分这样的技术被归类到流处理主题，更多信息见[CEP vs Stream Process](https://iwringer.wordpress.com/2015/12/15/cep-vs-streaming-processing-vs-cep-engines-vs-streaming-analytic-engines/)

当思考实时分析的时候，很多人仅仅考虑计算用例。计算用例只是现实生活中实时用例的冰山一角。由于输入数据以数据流的形式到达，一个时间维度总是存在于数据中。这个时间维度允许我们实现和执行许多有用的用例。例如，许多流处理引擎支持的流式SQL提供了像窗口，连接和时间序列检测等操作。

像Apache Samza和Apache Storm这样的大规模流处理分析主题下的流处理技术以及获得了很多关注。但是，这些工具迫使每个程序员以第一主体来设计和实现实时分析处理。

例如，如果用户需要一个时间窗口，他们需要以第一主体来实现它they (need to implement it from first principals)。这就像每个程序员实现他自己的列表数据结构。

从2016年以来，一个名为[流式SQL](https://www.quora.com/What-is-a-Streaming-SQL-What-are-the-tools-supporting-Streaming-SQL?awc=15748_1554000861_38c010be11a6674896e54624d1dbda61&campaign=uad_mkt_en_acq_us_awin&medium=ad&set=awin&source=awin&txtv=8&uiv=6)的新想法出现了。我们调用一种叫做流式SQL的语言，它能够让用户写类似SQL的查询来查询流数据。现在几乎所有的流处理引擎都支持流式SQL

但是，与使用像Java这样的语言写代码相比，写流处理应用需要非常不一样的思维模式。更好的理解流处理中的常见模式将使我们更好的理解该领域（domain）并构建处理这些场景的工具。这篇指南描述十三个常见的流处理分析模式以及如何实现它们。在本讨论中，我们将大量使用在流处理和其他技术下完成的现实用例。

## 实时流分析模式
在阅读这些模式之前，让我们首先就术语达成一致。流处理接受输入作为一组流，每个流包含许多时间有序的事件。每个事件有许多属性，但是同一个流中的所有事件具有相同的属性集和模式(schema)

## 模式一：预处理
预处理通常作为从一个数据流到另一个数据流的投影或通过过滤来完成。潜在的操作包括：
+ 过滤和移除一些事件
+ 通过移除，重命名，添加新的属性来裁剪一个流
+ 拆分和组合流中的属性
+ 转换属性

例如，从一个推特数据流中，我们可能选择抽取这些字段：作者，时间戳，位置以及根据作者位置过滤他们。

## 模式二：警告和阀值
这种模式检测一种情况并且根据这个情况生成警告（例如：高温警告）。这些警告基于一个值或更复杂的条件，例如增长率等。

例如，在基于伦敦公路数据的TFL（伦敦交通局）演示视频中，我们会在公交车超速的时候触发一个告警。[演示视频](https://youtu.be/mjPPbTFAqes)。我们也可以为服务器机房温度在过去五分钟内持续升高等情况生成警报。

## 模式三：简单的计算和窗口计算
这个模式包括像求最小值，求最大值，求百分数等聚合函数，并且可以在不排序的情况下进行计算。（例如，计算失败的交易数）

但是，计算通常与附加的时间窗口一起使用。(例如过去一小时的失败数)。有许多类型的窗口：滑动窗口与 批量(滚动)窗口和时间与长度窗口。

主要有四种变体：
> 译者注：窗口用来决定计算哪些数据（默认带有最近语义），以及何时产生输出。
+ 时间滑动窗口：保留给定时间窗口的每个事件，每当添加或删除新事件时产生输出
+ 时间批量窗口：也叫滚动窗口，他们只在时间窗口结束时产生输出
+ 长度滑动窗口：与时间滑动窗口类似，但保留一个n个事件的窗口而不是按时间保留他们
+ 长度批量窗口：与时间批量窗口类似，但保留一个n个事件的窗口而不是按时间保留他们

还有一些像衰减窗口和唯一窗口这样的特殊窗口，更多信息请参见[流处理101：10分钟内从SQL到流式SQL](https://wso2.com/library/articles/2018/02/stream-processing-101-from-sql-to-streaming-sql-in-ten-minutes/)

## 模式四：连接事件流
这个模式背后的主要思想是匹配多个数据流并创建新的数据流。举个例子，假设我们玩一个足球比赛，球员和球都有传感器发射具有当前位置和加速度的事件。我们可以使用“连接”来检测球员踢球的时间。为此，我们可以连接球位置流和球员流，条件是它们彼此接近一米并且球的加速度增加超过55m / s ^ 2。

在其他用例中，组合来自两个传感器的数据，并检测两辆车的接近程度。有关详细信息，请参阅[流处理101：十分钟内从SQL到流式SQL](https://wso2.com/library/articles/2018/02/stream-processing-101-from-sql-to-streaming-sql-in-ten-minutes/)

## 模式五：事件关联，丢失数据和错误数据
这个模式和模式四有很多共同点，这里我们也匹配多个事件流。此外，我们还关联同一流中的数据。这是因为不同的传感器会用不同的速率发送事件并且许多用例需要这种基础的操作。

下面是一些可能的场景：
+ 匹配两个以不同速度发送事件的数据流
+ 检测一个数据流中丢失的事件。(例如，检测在接收后一小时内未响应的客户请求)
+ 检测错误数据(例如，使用一组监测重叠区域的传感器检测故障传感器，并使用这些冗余数据查找错误传感器并在进一步处理中删除其数据)

## 模式六：与数据库交互
通常我们需要将实时数据和存储在磁盘上的历史数据相结合，下面是一些例子：
+ 当一笔交易发生，使用客户ID从客户数据库中查询年龄来进行诈骗检测
+ 检测一笔交易在数据库中的白名单和黑名单中
+ 接收来自用户的输入(例如，每天更新数据库中的折扣金额，然后查询将自动选择它们而无需人为干涉)

## 模式七：检测时间序列模式
使用正则表达式，我们能够从一个字符序列中检测字符模式。类似的，给定一个事件序列，我们可以编写规则表达式来检测按时排列的事件的时间序列，这些事件中的每个事件与上面例子中的字符串中的每个字符是等价的。

一个经常被引用，虽然有点简单的例子是：一个小偷，已经偷了一张信用卡，会尝试较小的交易并确保成功，然后会做一个大的交易。这里的大交易紧跟着小交易就是一个按时排序的事件的时间序列并且能够在一个事件序列上写规则表达式进行检测。

这样的时间序列模式是非常有用的。下面的视频展示了通过收集真实足球比赛数据进行实时分析的例子。这个数据集从DEBS 2013 Grand Challenge获取。[视频地址](https://youtu.be/nRI6buQ0NOM)

在视频中，我们在事件序列上使用模式来检测球控制，特定球员控制球的时间段。一名球员从他开始踢到球开始一直控制着球，直到其他人踢到球结束。这种情况能被写成一个规则表达式：被我踢到球，紧接着我连续踢到任意次球，直到其他人踢到球。（我们以及在模式四：连接讨论了如何检测踢到球的事件）

更多信息请参考[流处理101:十分钟从SQL到流式SQL](https://wso2.com/library/articles/2018/02/stream-processing-101-from-sql-to-streaming-sql-in-ten-minutes/)

## 模式八：跟踪
第八种模式在时间上和空间上跟踪某些事物并且检测给定的状况。下面是一些例子：
+ 跟踪车流，确保它们遵守速度限制，路线和地理围栏
+ 跟踪野生动物，确认他们存活（如果他们不移动，就可能死了）并且确保他们不会离开保护区。
+ 跟踪航空行李，确保他们没有送往错误的目的地
+ 跟踪物流网络并找出瓶颈和意外情况

例如，我们在模式二讨论的TFL Demo展示了一个使用伦敦交通局开放的数据流跟踪和监控公交车的应用。

## 模式九：检测趋势
我们经常遇到时间序列数据。从时间序列数据中检测模式，并引起操作人员的注意是一种常见的用例

以下是一些趋势的例子:
+ 上升，下降
+ 转折
+ 离群值
+ 像三重底线这样的复杂趋势等

这些趋势在大量的用例中都是非常有用的，例如:
+ 股票市场和算法交易
+ 确保SLA(服务水平协议)，自动扩展，负载均衡
+ 预测性维护（例如猜测磁盘将下周写满）

## 模式十：在批量和实时管道上运行相同的查询
这个模式在实时和批量管道上运行相同的查询。它通常用来填补批处理留下的空隙。例如，如果每十五分钟进行一次批处理，结果缺少最近十五分钟的数据。

这个模式的思想，有的时候被叫做"Lambda 架构"用实时分析填补空隙。Jay Kreps的文章["Lambda 架构的问题"](https://www.oreilly.com/ideas/questioning-the-lambda-architecture)详细讨论了这种模式。

## 模式十一：检测并切换到详细分析
这个模式的主要思想是检测到一种推荐使用历史数据进一步分析的状况。这种模式被用于我们没法对所有数据进行详细分析的用例。相反，我们只对异常情况进行详细分析。接下来是一些例子：
+ 使用基本的规则检测诈骗（例如，大量交易），然后从批处理管道中取出更长时间段(例如三个月)针对该信用卡完成的所有交易，并进行详细分析
+ 当监控天气的时候，在给定的区域检测高温和低压情况，然后在该地区开始高分辨率的本地化预测
+ 检测优质客户，例如通过一个月超过1000美元的支出，然后运行详细的模型来决定交易潜力。

## 模式十二：使用一个模型
这个想法就是训练一个模型（通常是一个机器学习模型），然后把它用到实时管道做决策。例如你能使用R语言构建一个模型，导出为PMML（预测模型标记语言），并在实时管道中使用它

其中的一些例子是诈骗检测，分割，预测下一个值，预测流失。另请参阅InfoQ文章[用于预测性维护的机器学习技术](https://www.infoq.com/articles/machine-learning-techniques-predictive-maintenance)，以获取此模式的详细示例。

## 模式十三：在线控制
有许多用例需要在线控制某些事物。经典的用例是自动驾驶仪，自动驾驶和机器人技术。这将涉及到当前情况感知，预测下一个值和决定纠正措施等问题。

你可以使用支持流式SQL的流处理引擎来实现大部分这种用例。流式SQL的细节讨论请参考[流处理101:十分钟从SQL到流式SQL](https://wso2.com/library/articles/2018/02/stream-processing-101-from-sql-to-streaming-sql-in-ten-minutes/)。你可以使用[WSO2流处理引擎](https://wso2.com/analytics)，它在Apache许可2下免费。你也可以从[什么是最好的流处理引擎解决方案](https://www.quora.com/What-are-the-best-stream-processing-solutions-out-there?awc=15748_1554023459_4710084300249e11b4bb8b642e506089&uiv=6&txtv=8&source=awin&medium=ad&campaign=uad_mkt_en_acq_us_awin&set=awin)

本文最初基于DEBS 2015（第九届ACM国际分布式事件系统会议）的教程，描述一组实时分析模式。我们后来编辑了内容以增加流式SQL等趋势

你可以从这个PPT[ACM DEBS 2015:实时流分析模式](https://www.slideshare.net/hemapani/debs-2015-tutorial-1)找到实现细节，源代码在https://github.com/suhothayan/DEBS-2015-Realtime-Analytics-Patterns 。虽然Streaming SQL语法紧跟最新版本的WSO2 SP，但语法上有一些细微的变化。有关最新语法，请参阅WSO2 SP用户指南。

希望这些有用。如果你喜欢本文，你也可能对下面这些感兴趣
+ [流处理101:十分钟从SQL到流式SQL](https://wso2.com/library/articles/2018/02/stream-processing-101-from-sql-to-streaming-sql-in-ten-minutes/)
+ [用于预测性维护的机器学习技术](https://www.infoq.com/articles/machine-learning-techniques-predictive-maintenance) 
